<body>
  <meta name="csrf-token" content="<%= form_authenticity_token %>"> 
  <div class="flex flex-col justify-center items-center min-h-screen bg-red-50">
    <div class="text-3xl text-center font-mono text-sky-900 p-6">
    ã‚¹ãƒˆãƒƒãƒ—ã‚¦ã‚©ãƒƒãƒ
    </div>
    <div class="p-20 bg-white rounded-2xl shadow-xl text-center">
      <div id ="timer" class="text-6xl font-mono  text-sky-900 mb-4">
        00:00
      </div>
      <% if user_signed_in? %>
        <div class="mb-4"> 
          <select id="mealType" class="px-6 py-2 border rounded text-sky-900 border-gray-400 font-mono">
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            <option value="breakfast">æœã”ã¯ã‚“</option>
            <option value="lunch">æ˜¼ã”ã¯ã‚“</option>
            <option value="dinner">å¤œã”ã¯ã‚“</option>
          </select>
        </div>
      <% end %>
        <button id="startTimer" class="px-6 py-2 border rounded  text-sky-900 border-gray-400 hover:bg-red-100 focus:outline-none font-mono">
          ã‚¹ã‚¿ãƒ¼ãƒˆ
        </button>
      <% if user_signed_in? %>
        <button id="onClickPost" class="px-6 py-2 border rounded text-sky-900 border-gray-400 hover:bg-red-100 focus:outline-none font-mono">
          ä¿å­˜
        </button>
      <% else %>
        <div class=" mt-4 text-sky-900"> 
          15åˆ†ä»¥ä¸Šã‹ã‘ã¦ã‚ˆãã‹ã‚“ã§é£Ÿã¹ã¾ã—ã‚‡ã†ã€œï¼
          <br>â€»ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã¯LINEãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ğŸ™‡â€â™€ï¸ 
        </div>
      <% end %>
      </div>
    </div>
  </div>

  <script>
    const url = "https://jsonplaceholder.typicode.com/posts"
    const getPosts = async () => {
    const res = await fetch(url)
    const data = await res.json()
    await console.log(data)
    } 

    let startTime;
    let endTime;

    let seconds = 0;
    let minutes = 0;
    let hours = 0;
    let intervalId;

document.addEventListener('visibilitychange', function() {
    if (document.visibilityState === 'visible') {
        // ãƒšãƒ¼ã‚¸ãŒå†ã³è¡¨ç¤ºã•ã‚ŒãŸã‚‰çµŒéæ™‚é–“ã‚’è¨ˆç®—
        updateElapsedTime();
    }
});

function updateElapsedTime() {
    const startTime = localStorage.getItem('startTime');
    const endTime = localStorage.getItem('endTime');

    if (startTime && endTime) {
        // ã‚¹ã‚¿ãƒ¼ãƒˆæ™‚åˆ»ã¨ã‚¨ãƒ³ãƒ‰æ™‚åˆ»ãŒãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹å ´åˆã€çµŒéæ™‚é–“ã‚’è¨ˆç®—
        const start = new Date(startTime);
        const end = new Date(endTime);
        const elapsedTimeMs = end - start;
        displayElapsedTime(elapsedTimeMs);
    }
}

function displayElapsedTime(elapsedTimeMs) {
    // çµŒéæ™‚é–“ã‚’åˆ†ã¨ç§’ã«å¤‰æ›
    const seconds = Math.floor(elapsedTimeMs / 1000);
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = seconds % 60;

    // ã‚¿ã‚¤ãƒãƒ¼ã®è¡¨ç¤ºã‚’æ›´æ–°
    document.getElementById("timer").innerText = `${minutes}:${remainingSeconds.toString().padStart(2, "0")}`;
}

    function toggleTimer() {
      const startButton = document.getElementById("startTimer");
      if (startButton.innerText === "ã‚¹ã‚¿ãƒ¼ãƒˆ") {
        startTimer();
        startButton.innerText = "ã‚¹ãƒˆãƒƒãƒ—"; // ãƒ†ã‚­ã‚¹ãƒˆã‚’ 'stop ã«å¤‰æ›´
      } else {
        stopTimer();
      startButton.innerText = "ã‚¹ã‚¿ãƒ¼ãƒˆ"; // ãƒ†ã‚­ã‚¹ãƒˆã‚’ 'start' ã«æˆ»ã™
      } 
    }

    function startTimer() {
    startTime = new Date();  
    intervalId = setInterval(updateTimer, 1000);
    }

  function stopTimer() {
    clearInterval(intervalId);
    endTime = new Date();
    const elapsedTimeMs = endTime - startTime; // ãƒŸãƒªç§’å˜ä½ã§çµŒéæ™‚é–“ã‚’è¨ˆç®—
    console.log(`Elapsed Time: ${elapsedTimeMs} milliseconds`);
  }

    function updateTimer() {
    seconds++;
    if (seconds === 60) {
        minutes++;
        seconds = 0;
    }
    if (minutes === 60) {
        hours++;
        minutes = 0;
    }
    const formattedSeconds = seconds.toString().padStart(2, "0");
    const formattedMinutes = minutes.toString().padStart(2, "0");
    const formattedHours = hours.toString().padStart(2, "0");
    document.getElementById("timer").innerText = `${formattedHours}:${formattedMinutes}:${formattedSeconds}`;
    }

  function onClickPost() {
    if (!startTime) {
      alert('ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚');
      return; // ã“ã‚Œä»¥ä¸Šã®å‡¦ç†ã‚’è¡Œã‚ãªã„
    }
    if (!endTime) {
        endTime = new Date();
    }
    const mealType = document.getElementById("mealType").value;
    console.log("Selected meal type:", mealType);
    if (!mealType) {
      alert('æœªå…¥åŠ›ã®é …ç›®ãŒã‚ã‚Šã¾ã™');
      return; 
    }

    const url = "/stopwatches"; 
    const obj = {
      stopwatch: {
        start_time: startTime.toISOString(),
        end_time: endTime.toISOString(),
        meal_type: mealType
      }
    };

    console.log(JSON.stringify(obj));
    const csrfToken = document.querySelector("meta[name='csrf-token']").getAttribute("content");
    fetch(url, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRF-Token": csrfToken
        },
        body: JSON.stringify(obj)
    })
    .then(response => {
    if (!response.ok) {
      throw new Error('Network response was not ok');
    }
    return response.json();
  })
  .then(data => {
    window.location.href = `/stopwatches/${data.id}`;
  })
  .catch(error => {
    console.error('Error:', error);
  });
}

  document.addEventListener('DOMContentLoaded', () => {
  document.getElementById("startTimer").addEventListener("click", toggleTimer);
  document.getElementById("onClickPost").addEventListener("click", onClickPost);
});
  </script>
</body>
