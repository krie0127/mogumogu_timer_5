<body>
  <meta name="csrf-token" content="<%= form_authenticity_token %>"> 
  <div class="flex flex-col justify-center items-center min-h-screen bg-red-50">
    <div class="text-3xl text-center font-mono text-sky-900 p-6">
    ã‚¹ãƒˆãƒƒãƒ—ã‚¦ã‚©ãƒƒãƒ
    </div>
    <div class="p-20 bg-white rounded-2xl shadow-xl text-center">
      <div id ="timer" class="text-6xl font-mono  text-sky-900 mb-4">
        00:00
      </div>
      <% if user_signed_in? %>
      <div class="mb-4"> <!-- ãƒãƒ¼ã‚¸ãƒ³ãƒœãƒˆãƒ ã‚’è¿½åŠ ã—ã¦é¸æŠã¨ãƒœã‚¿ãƒ³é–“ã®ã‚¹ãƒšãƒ¼ã‚¹ã‚’ç¢ºä¿ -->
        <select id="mealType" class="px-6 py-2 border rounded text-sky-900 border-gray-400 font-mono">
          <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
          <option value="breakfast">æœã”ã¯ã‚“</option>
          <option value="lunch">æ˜¼ã”ã¯ã‚“</option>
          <option value="dinner">å¤œã”ã¯ã‚“</option>
        </select>
      </div>
      <% end %>
        <button id="startTimer" class="px-6 py-2 border rounded  text-sky-900 border-gray-400 hover:bg-red-100 focus:outline-none font-mono">
          ã‚¹ã‚¿ãƒ¼ãƒˆ
        </button>
        <% if user_signed_in? %>
        <button id="onClickPost" class="px-6 py-2 border rounded text-sky-900 border-gray-400 hover:bg-red-100 focus:outline-none font-mono">
          ä¿å­˜
        </button>
        <% else %>
      <div class=" mt-4 text-sky-900"> 
        15åˆ†ä»¥ä¸Šã‹ã‘ã¦ã‚ˆãã‹ã‚“ã§é£Ÿã¹ã¾ã—ã‚‡ã†ã€œï¼
        <br>â€»ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã¯LINEãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ğŸ™‡â€â™€ï¸ </br>
      </div>
      <% end %>
      </div>
    </div>
  </div>

  <script>
    const url = "https://jsonplaceholder.typicode.com/posts"
    const getPosts = async () => {
    const res = await fetch(url)
    const data = await res.json()
    await console.log(data)
    } 

    let seconds = 0;
    let minutes = 0;
    let hours = 0;
    let intervalId;

    function toggleTimer() {
      const startButton = document.getElementById("startTimer");
      if (startButton.innerText === "ã‚¹ã‚¿ãƒ¼ãƒˆ") {
        startTimer();
        startButton.innerText = "ã‚¹ãƒˆãƒƒãƒ—"; // ãƒ†ã‚­ã‚¹ãƒˆã‚’ 'stop ã«å¤‰æ›´
      } else {
        stopTimer();
      startButton.innerText = "ã‚¹ã‚¿ãƒ¼ãƒˆ"; // ãƒ†ã‚­ã‚¹ãƒˆã‚’ 'start' ã«æˆ»ã™
      } 
    }

    function startTimer() {
    startTime = new Date();  
    intervalId = setInterval(updateTimer, 1000);
    }

    function stopTimer() {
    clearInterval(intervalId);
    endTime = new Date();  
    }

    function updateTimer() {
    seconds++;
    if (seconds === 60) {
        minutes++;
        seconds = 0;
    }
    if (minutes === 60) {
        hours++;
        minutes = 0;
    }
    const formattedSeconds = seconds.toString().padStart(2, "0");
    const formattedMinutes = minutes.toString().padStart(2, "0");
    const formattedHours = hours.toString().padStart(2, "0");
    document.getElementById("timer").innerText = `${formattedHours}:${formattedMinutes}:${formattedSeconds}`;
    }

  function onClickPost() {
    const mealType = document.getElementById("mealType").value;
    console.log("Selected meal type:", mealType);
    if (!mealType) {
      alert('æœªå…¥åŠ›ã®é …ç›®ãŒã‚ã‚Šã¾ã™');
      return; 
    }

    const url = "/stopwatches"; 
    const obj = {
      stopwatch: {
        start_time: startTime.toISOString(),
        end_time: endTime.toISOString(),
        meal_type: mealType
      }
    };

    console.log(JSON.stringify(obj));
    const csrfToken = document.querySelector("meta[name='csrf-token']").getAttribute("content");
    fetch(url, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRF-Token": csrfToken
        },
        body: JSON.stringify(obj)
    })
    .then(response => {
    if (!response.ok) {
      throw new Error('Network response was not ok');
    }
    return response.json();
  })
  .then(data => {
    // æˆåŠŸã—ãŸå ´åˆã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰å¾—ã‚‰ã‚ŒãŸstopwatchã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®idã‚’ä½¿ç”¨ã—ã¦ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹
    window.location.href = `/stopwatches/${data.id}`;
  })
  .catch(error => {
    console.error('Error:', error);
  });
}

    // .then(response => response.json())
    // .then(data => console.log(data))
    // .catch(error => {
    //     console.error('Error:', error);
    //     if (error.response && error.response.data) {
    //         console.log(error.response.data);
    //     }
  //   });
  // }

  // document.addEventListener('DOMContentLoaded', () => {
  //   document.getElementById("startTimer").addEventListener("click", toggleTimer);
  //   document.getElementById("onClickPost").addEventListener("click", function() {
  //   onClickPost(); 
  //   // ãƒ‡ãƒ¼ã‚¿é€ä¿¡å‡¦ç†ãŒå®Œäº†ã—ãŸã¨æƒ³å®šã—ã¦ã€ãƒã‚¤ãƒšãƒ¼ã‚¸ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
  //   window.location.href = "<%= my_page_stopwatches_path %>"; 
  // })});

  document.addEventListener('DOMContentLoaded', () => {
  document.getElementById("startTimer").addEventListener("click", toggleTimer);
  document.getElementById("onClickPost").addEventListener("click", onClickPost);
});
  </script>
</body>
